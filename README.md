# CVE-2022-0778

**Contributors**

-    [정준수(@jeongjunsoo)](https://github.com/jeongjunsoo) 

<br/>


###  요약

-    CVE-2022-0778 취약점은 OpenSSL의 소수에 대한 모듈로 제곱근을 계산하는  `BN_mod_sqrt()`함수를 공격 대상으로 합니다. 

-    이 함수가 소수를 사용 하지 않는 악의적인 인증서를 만나게 되면 패치되지 않은 서버에서 DoS 상태가 됩니다.

<br/>

###  Target
-   OpenSSL 1.0.2
-   OpenSSL 1.1.1
-   OpenSSL 3.0

<br/>


### 패치 전
```
i = 1;
if (!BN_mod_sqr(t, b, p, ctx))
    goto end;
while (!BN_is_one(t)) {
    i++;
    if (i == e) {
        ERR_raise(ERR_LIB_BN, BN_R_NOT_A_SQUARE);
        goto end;
    }
    if (!BN_mod_mul(t, t, t, p, ctx))
        goto end;
}

```

알고리즘에 따르면 고정된 e와 증가하는 i에 대해 해당 loop는 `i==e` 인 시점에 끝나야 합니다.

하지만 특수한 입력값을 주어 `i=1, e=1` 인 상태로 해당 loop에 진입하도록 유도한다면 무한 loop가 발생하여 서비스 거부가 발생하게 됩니다.


<br/>

### 패치 후

```
for (i = 1; i < e; i++) {
    if (i == 1) {
        if (!BN_mod_sqr(t, b, p, ctx))
            goto end;
    } else {
        if (!BN_mod_mul(t, t, t, p, ctx))
            goto end;
    }
    if (BN_is_one(t))
        break;
}
/* If not found, a is not a square or p is not prime. */
if (i >= e) {
    ERR_raise(ERR_LIB_BN, BN_R_NOT_A_SQUARE);
    goto end;
}

```

- while → for 
- for 루프는 i < e 의 조건을 가지므로 i 의 최대 값은 e입니다. 따라서 i == e 일 때 반복문이 종료됩니다.
- 앞선 패치를 통해 무한 loop가 발생하지 않도록 했습니다.

<br/>

### 환경 구성 및 실행

- `docker compose up -d` 커맨드를 입력해 테스트 환경을 실행

- `docker run -it --rm -p 12345:12345 yywing/cve-2022-0778 --addr 0.0.0.0:12345`

- `docker compose exec curl top`

- `docker compose exec curl bash`

- `curl -k https://host.docker.internal:12345`

<br/>

### 실행

- 터미널 3개(A, B, C)를 사용합니다.
![](result1.png)
- A 터미널에서 `docker run -it --rm -p 12345:12345 yywing/cve-2022-0778 --addr 0.0.0.0:12345` 실행합니다.

<br/>

![](result2.png)
- B 터미널에서 `docker compose exec curl top` 명령어를 통해 프로세스 정보를 확인합니다.

<br/>


![](result3.png)
- C 터미널에서 `docker compose exec curl bash` 입력 후 `curl -k https://host.docker.internal:12345` 실행합니다.

<br/>

### 결과

![](result4.png)
- B 터미널에서 curl 프로세스를 확인하면 CPU를 100% 가량 사용하는 걸 확인할 수 있습니다. DoS 때문


<br/>



### 정리


<br/>